---
layout: default
---

{% include header.html %}

<main>
  <div class="container careers page">
    <main class="content">
      <h1>Visualizer</h1>

      <p>Example...</p>

      <script src="https://unpkg.com/vue"></script>
      <script src="https://data-visualizer.populate.tools/dist/my-visualizer.min.js"></script>
      <script>
        let dataset0;
        let dataset1;
        let dataset2;

        const populate = [
          {
            id: "ds-contratos-municipio",
            freq: "month",
            name: "Número de contratos",
            units: "contratos",
            ranges: [2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019]
          },
          {
            id: "ds-poblacion-municipal",
            name: "Población",
            units: "habitantes",
            ranges: [2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018]
          },
          {
            id: "ds-defunciones-municipal",
            name: "Defunciones",
            units: "defunciones",
            ranges: [2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017]
          },
          {
            id: "ds-empresas-municipio",
            name: "Empresas",
            units: "empresas",
            ranges: [2014]
          },
          {
            id: "ds-deuda-municipal",
            name: "Deuda",
            units: "€",
            ranges: [2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017]
          },
          {
            id: "ds-afiliados-ss-municipio",
            freq: "month",
            name: "Afiliados a la Seg. Social",
            units: "afiliados",
            ranges: [2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019]
          },
          {
            id: "ds-personas-paradas-municipio",
            freq: "month",
            name: "Personas paradas",
            units: "desempleados",
            ranges: [2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019]
          },
          {
            id: "ds-renta-bruta-media-municipal",
            name: "Renta bruta media",
            units: "€",
            ranges: [2014, 2016]
          },
          {
            id: "ds-nacimientos-municipal",
            name: "Nacimientos",
            units: "nacimientos",
            ranges: [2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017]
          },
          {
            id: "ds-presupuestos-municipales-funcional",
            name: "Presupuestos, partidas funcionales"
          },
          {
            id: "ds-presupuestos-municipales-economica",
            name: "Presupuestos, partidas económicas"
          }
        ];
        const helperDatasetQuery = (param, range) => {
          const isMonthly = populate.some(d => d.id === param && d.freq === "month");

          if (isMonthly) {
            range = new Date().getFullYear() === range ? `${range}-01` : `${range}-12`;
          }

          return `datasets/${param}.json?filter_by_date=${range}&include=municipality,province`;
        };
        const helperCollectionQuery = (param, range) => {
          const { code, area, kind } = dataset2.find(d => d.code === param.toString());

          const dataset = area === "functional" ? "ds-presupuestos-municipales-funcional" : "ds-presupuestos-municipales-economica";
          const type = kind === "expense" ? "G" : "I";

          return `datasets/${dataset}.json?filter_by_code=${code}&filter_by_kind=${type}`;
        };
        const RANGES_DEFAULT = [
          2000,
          2001,
          2002,
          2003,
          2004,
          2005,
          2006,
          2007,
          2008,
          2009,
          2010,
          2011,
          2012,
          2013,
          2014,
          2015,
          2016,
          2017,
          2018
        ];
        const config = {
          charts: [
            {
              xAxisProp: "value1",
              yAxisProp: "value0",
              aggregationProp: "province_desc",
              btnPlaceholder: "Añadir provincia",
              tooltip: d => {
                const { units: units0, name: name0 } = populate.find(d => d.id === dataset0);
                const { units: units1, name: name1 } = populate.find(d => d.id === dataset1);

                return `<div style="padding: 1rem;"><div style="margin: 0 0 8px"><strong>${d.location_desc}</strong> (${
                  d.province_desc
                })</div><div>${name0}: ${d.value0.toLocaleString()} ${units0}</div><div>${name1}: ${d.value1.toLocaleString()} ${units1}</div></div>`;
              },
              xScaleFunction: d3 => d3.scaleSqrt().exponent(0.2),
              yScaleFunction: d3 => d3.scaleSqrt().exponent(0.4)
            },
            {
              xAxisProp: "value1",
              yAxisProp: "value0",
              aggregationProp: "province_desc",
              legendLabels: ["Más", "Menos"],
              averageLabel: "Media",
              medianLabel: "Mediana",
              sampleSize: 3,
              baseDataset: "ds-poblacion-municipal",
              tooltip: d => {
                const { units: units0, name: name0 } = populate.find(d => d.id === dataset0);
                const { units: units1, name: name1 } = populate.find(d => d.id === dataset1);

                return `<div style="padding: 1rem;"><div style="margin: 0 0 8px"><strong>${d.location_desc}</strong> (${
                  d.province_desc
                })</div><div>${name0}: ${d.value0.toLocaleString()} ${units0}</div><div>${name1}: ${d.value1.toLocaleString()} ${units1}</div></div>`;
              },
              xScaleFunction: d3 => d3.scaleSqrt().exponent(0.2),
              yScaleFunction: d3 => d3.scaleSqrt().exponent(0.4)
            }
          ],
          ranges: dataset => {
            if (!dataset) {
              return RANGES_DEFAULT;
            }

            const { ranges } = populate.find(d => d.id === dataset);
            return ranges;
          },
          setup: {
            baseURL: "https://data.populate.tools/visualizador/",
            headers: { Authorization: "Bearer WxVwwI-uTEVzvP6RF8FiFg" }
            // timeout: 10000
          },
          endpoints: {
            series: {
              build: () => ["datasets.json", "collections/c-categorias-presupuestos-municipales/items.json"],
              parse: data => {
                const [datasets, collections] = data;

                // Handle user selections
                dataset2 = collections;

                return Object.values(datasets)
                  .filter(d => populate.some(f => f.id === d.id))
                  .map(d => ({ id: d.id, name: d.name }))
                  .sort((a, b) => populate.findIndex(d => d.id === a.id) - populate.findIndex(d => d.id === b.id))
                  .concat(collections.map(d => ({ id: parseInt(d.code), name: d.name })));
              }
            },
            data: {
              build: params => {
                const req = [];

                if (params.varX) {
                  if (Number.isInteger(params.varX)) {
                    req.push(helperCollectionQuery(params.varX, params.range));
                  } else {
                    req.push(helperDatasetQuery(params.varX, params.range));
                  }
                }
                if (params.varY) {
                  req.push(helperDatasetQuery(params.varY, params.range));
                }

                // Handle user selections
                dataset0 = params.varX;
                dataset1 = params.varY;

                return req;
              },
              parse: data => {
                const arrMerged = [];
                const [arr0 = [], arr1 = []] = data;

                if (arr0.length && arr1.length) {
                  if (arr0.some(d => d.hasOwnProperty("organization_id"))) {
                    arr0.forEach(d => {
                      const itemMerged = {};
                      const matchedItem = arr1.find(g => parseInt(g.location_id) === parseInt(d.ine_code));
                      if (matchedItem) {
                        itemMerged.value0 = parseInt(d.amount);
                        itemMerged.value1 = parseInt(matchedItem.value);
                        itemMerged.location_id = parseInt(d.ine_code);
                        itemMerged.location_desc = matchedItem.municipality_name;
                        itemMerged.province_id = parseInt(d.province_id);
                        itemMerged.province_desc = matchedItem.province_name;

                        arrMerged.push(itemMerged);
                      }
                    });
                  } else {
                    arr0.forEach(d => {
                      // Ignore if there's no location. It won't match
                      if (d.location_id) {
                        const itemMerged = {};

                        itemMerged.value0 = parseInt(d.value);
                        itemMerged.value1 = parseInt((arr1.find(g => parseInt(g.location_id) === parseInt(d.location_id)) || {}).value);
                        itemMerged.location_id = parseInt(d.location_id);
                        itemMerged.location_desc = d.municipality_name;
                        itemMerged.province_id = parseInt(d.province_id);
                        itemMerged.province_desc = d.province_name;

                        arrMerged.push(itemMerged);
                      }
                    });
                  }
                } else if (arr0.length) {
                  arrMerged.concat(arr0);
                } else if (arr1.length) {
                  arrMerged.concat(arr1);
                }

                return arrMerged;
              }
            }
          }
        };

        Vue.prototype.$config = config;
      </script>

      <my-visualizer></my-visualizer>
    </main>
  </div>
</main>
