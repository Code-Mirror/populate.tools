---
layout: default
---

{% include header.html %}

<main>
  <div class="container careers page">
    <main class="content">
      <h1>Visualizer</h1>

      <p>Example...</p>

      <script src="https://unpkg.com/vue"></script>
      <script src="https://data-visualizer.populate.tools/dist/my-visualizer.min.js"></script>
      <script>
        const populate = [
          {
            id: "ds-poblacion-municipal",
            name: "Población",
            units: "habitantes",
            ranges: [2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017]
          },
          {
            id: "ds-defunciones-municipal",
            name: "Defunciones",
            units: "defunciones"
          },
          {
            id: "ds-autonomos-municipio",
            freq: "month",
            name: "Número de autónomos",
            units: "autónomos"
          },
          {
            id: "ds-contratos-municipio",
            freq: "month",
            name: "Número de contratos",
            units: "contratos"
          },
          {
            id: "ds-empresas-municipio",
            name: "Empresas",
            units: "empresas"
          },
          {
            id: "ds-deuda-municipal",
            name: "Deuda",
            units: "€"
          },
          {
            id: "ds-afiliados-ss-municipio",
            freq: "month",
            name: "Afiliados a la Seg. Social",
            units: "afiliados"
          },
          {
            id: "ds-personas-paradas-municipio",
            freq: "month",
            name: "Personas paradas",
            units: "desempleados"
          },
          {
            id: "ds-renta-bruta-media-municipal",
            name: "Renta bruta media",
            units: "€"
          },
          {
            id: "ds-nacimientos-municipal",
            name: "Nacimientos",
            units: "nacimientos"
          },
          {
            id: "ds-presupuestos-municipales",
            name: "Presupuesto",
            units: "€"
          }
        ];

        let dataset0;
        let dataset1;

        const config = {
          setup: {
            baseURL: "https://data.populate.tools/visualizador/",
            headers: { Authorization: "Bearer WxVwwI-uTEVzvP6RF8FiFg" }
          },
          ranges: dataset => {
            if (!dataset) {
              return [2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019];
            }

            const { ranges } = populate.find(d => d.id === dataset);
            return ranges;
          },
          endpoints: {
            series: {
              build: () => "datasets.json",
              parse: data => {
                return {
                  data: Object.values(data)
                    .filter(d => populate.some(f => f.id === d.id))
                    .map(d => ({ id: d.id, name: d.name }))
                };
              }
            },
            data: {
              build: params => {
                const isMonthlyVarX = populate.some(d => d.id === params.varX && d.freq === "month");
                const isMonthlyVarY = populate.some(d => d.id === params.varY && d.freq === "month");

                let rangeX = params.range;
                let rangeY = params.range;

                if (isMonthlyVarX) {
                  rangeX = new Date().getFullYear() === rangeX ? `${rangeX}-01` : `${rangeX}-12`;
                }

                if (isMonthlyVarY) {
                  rangeY = new Date().getFullYear() === rangeY ? `${rangeY}-01` : `${rangeY}-12`;
                }

                // Handle user selections
                dataset0 = params.varX;
                dataset1 = params.varY;

                return [
                  `datasets/${params.varX}.json?filter_by_date=${rangeX}&include=municipality,province`,
                  `datasets/${params.varY}.json?filter_by_date=${rangeY}&include=municipality,province`
                ];
              },
              parse: data => {
                let response = {};
                const arrMerged = [];

                const [arr0, arr1] = data;
                if (arr0.length && arr1.length) {
                  arr0.forEach(d => {
                    // Ignore if there's no location. It won't match
                    if (d.location_id) {
                      const itemMerged = {};

                      itemMerged.value0 = parseInt(d.value);
                      itemMerged.value1 = parseInt((arr1.find(g => parseInt(g.location_id) === parseInt(d.location_id)) || {}).value);
                      itemMerged.location_id = parseInt(d.location_id);
                      itemMerged.location_desc = d.municipality_name;
                      itemMerged.province_id = parseInt(d.province_id);
                      itemMerged.province_desc = d.province_name;

                      arrMerged.push(itemMerged);
                    }
                  });

                  response = {
                    data: arrMerged,
                    props: {
                      xAxisProp: "value1",
                      yAxisProp: "value0",
                      aggregationProp: "province_id",
                      legendLabels: ["Más", "Menos"],
                      averageLabel: "Media",
                      medianLabel: "Mediana",
                      btnPlaceholder: "Añadir provincia",
                      tooltip: d => {
                        const { units: units0, name: name0 } = populate.find(d => d.id === dataset0);
                        const { units: units1, name: name1 } = populate.find(d => d.id === dataset1);

                        return `<div style="padding: 1rem;"><div style="margin: 0 0 8px"><strong>${d.location_desc}</strong> (${
                          d.province_desc
                        })</div><div>${name0}: ${d.value0.toLocaleString()} ${units0}</div><div>${name1}: ${d.value1.toLocaleString()} ${units1}</div></div>`;
                      },
                      xScaleFunction: d3 => d3.scaleSqrt().exponent(0.2),
                      yScaleFunction: d3 => d3.scaleSqrt().exponent(0.4)
                    }
                  };
                }

                return response;
              }
            }
          }
        };

        Vue.prototype.$config = config;
      </script>

      <my-visualizer></my-visualizer>
    </main>
  </div>
</main>
